{
  "feature": "live-analysis",
  "version": "1.1.0",
  "name": "Live Analysis",
  "description": "Real-time sales-call coaching with streaming audio, ASR, tone/prosody scoring, and LLM feedback to guide next best actions.",
  "goals": [
    "Show client sentiment + engagement in real time using text + tone (prosody) + conversation dynamics.",
    "Detect objections and risk signals early and provide evidence-backed coaching suggestions.",
    "Provide next-best-say and next-best-question prompts tailored to the current call context.",
    "Maintain privacy controls, confidence indicators, and an audit trail (evidence snippets)."
  ],
  "supportedPlatforms": {
    "web": {
      "audioSources": ["microphone", "tabAudioOptional"],
      "constraints": [
        "Capturing system audio for Teams/Zoom is not consistently supported in browsers.",
        "Tone scoring reliability depends on clean client audio separation."
      ]
    },
    "desktop": {
      "audioSources": ["microphone", "systemAudio"],
      "captureMethods": ["loopback", "virtualAudioDevice"],
      "recommended": true,
      "notes": [
        "Best option for reliably separating SALES (mic) vs CLIENT (system audio) to improve sentiment and tone accuracy."
      ]
    },
    "mobile": {
      "audioSources": ["microphone"],
      "constraints": [
        "Other-app audio capture is restricted (especially iOS).",
        "Use for in-person/speakerphone capture or if the call is inside your app."
      ]
    }
  },
  "rolesAndSpeakers": {
    "speakerRoles": ["SALES", "CLIENT", "UNKNOWN"],
    "roleAssignment": {
      "preferred": "byAudioSource",
      "fallback": "speakerClusteringPlusUserMapping",
      "byAudioSource": {
        "rules": [
          { "audioSource": "microphone", "role": "SALES" },
          { "audioSource": "systemAudio", "role": "CLIENT" }
        ]
      },
      "speakerClusteringPlusUserMapping": {
        "maxSpeakers": 2,
        "userPrompt": "Tap to select which speaker is you (Sales).",
        "persistMappingForMeeting": true
      }
    }
  },
  "pipeline": {
    "transport": {
      "clientToServer": ["websocket"],
      "serverToClient": ["websocket"],
      "fallbacks": ["sse"],
      "reconnect": {
        "enabled": true,
        "maxRetries": 10,
        "backoffMs": [250, 500, 1000, 2000, 4000]
      }
    },
    "audio": {
      "sampleRateHz": 16000,
      "channels": 1,
      "encoding": "pcm_s16le",
      "frameMs": 20,
      "packetMs": 1000,
      "maxJitterBufferMs": 200,
      "vad": {
        "enabled": true,
        "mode": "clientSide",
        "silenceFinalizeMs": 800,
        "minSpeechMs": 250
      },
      "noiseHandling": {
        "agc": true,
        "denoise": "optional",
        "dropIfClipping": true
      }
    },
    "asr": {
      "mode": "streaming",
      "partialResults": true,
      "rollingContextSec": 30,
      "language": {
        "autoDetect": true,
        "preferredLocales": ["en-GB", "en-US"]
      },
      "outputs": [
        "partialTranscript",
        "finalTranscript",
        "wordTimestampsOptional"
      ]
    },
    "toneProsody": {
      "enabled": true,
      "computeLocation": "clientOrServer",
      "requiresSpeakerRole": "CLIENT",
      "windowSec": 6,
      "strideSec": 2,
      "features": [
        "rmsEnergy",
        "pitchF0Mean",
        "pitchF0Variance",
        "speechRateProxy",
        "pauseRatio",
        "fillerWordRate",
        "overlapRateOptional"
      ],
      "derivedSignals": [
        { "key": "clientEnergy", "range": [0, 1] },
        { "key": "clientStress", "range": [0, 1] },
        { "key": "clientCertainty", "range": [0, 1] }
      ],
      "qualityGates": {
        "minSNRDb": 10,
        "minVoicedMs": 800,
        "fallbackToTextOnlyIfNoisy": true
      }
    },
    "analysisCadence": {
      "lightMetricsEveryMs": 2000,
      "deepInsightsEveryMs": 5000,
      "coachSuggestionCooldownMs": 8000,
      "timelineEventDebounceMs": 1500
    }
  },
  "analysis": {
    "windows": {
      "shortWindowSec": 20,
      "longWindowSec": 120,
      "meetingMemory": {
        "enabled": true,
        "summaryRefreshEverySec": 60,
        "stores": [
          "keyFacts",
          "statedNeeds",
          "constraints",
          "objections",
          "pricingTalk",
          "competitorMentions",
          "commitments",
          "nextSteps"
        ]
      }
    },
    "metrics": {
      "clientValence": { "range": [-1, 1], "confidenceRange": [0, 1] },
      "clientEngagement": { "range": [0, 1], "confidenceRange": [0, 1] },
      "callHealth": { "range": [0, 100], "confidenceRange": [0, 1] },
      "riskFlags": {
        "types": [
          "priceObjection",
          "timingObjection",
          "trustConcern",
          "featureGap",
          "securityConcern",
          "integrationConcern",
          "competitorMention",
          "confusion",
          "frustration",
          "lowEngagement",
          "scopeMismatch"
        ]
      },
      "talkDynamics": {
        "talkRatioSalesPct": { "range": [0, 100] },
        "talkRatioClientPct": { "range": [0, 100] },
        "interruptionsCount": { "range": [0, 999] },
        "paceWpmSales": { "range": [0, 300] },
        "paceWpmClient": { "range": [0, 300] }
      },
      "topicCoverage": {
        "topics": [
          "needProblem",
          "budget",
          "timeline",
          "decisionMaker",
          "alternativesCompetitors",
          "technicalFit",
          "securityCompliance",
          "procurement",
          "nextSteps"
        ],
        "output": {
          "checkedTopics": "string[]",
          "confidenceByTopic": "record<string, number>"
        }
      }
    },
    "fusionLogic": {
      "clientValence": {
        "textWeight": 0.75,
        "toneWeight": 0.25,
        "notes": "Text remains primary; tone refines/adjusts when quality gates pass."
      },
      "clientEngagement": {
        "dynamicsWeight": 0.6,
        "toneWeight": 0.4
      },
      "callHealth": {
        "components": [
          { "key": "clientValence", "weight": 0.25 },
          { "key": "clientEngagement", "weight": 0.25 },
          { "key": "riskFlagsSeverity", "weight": 0.3 },
          { "key": "topicCoverageScore", "weight": 0.2 }
        ]
      },
      "confidence": {
        "inputs": [
          "asrConfidence",
          "toneQuality",
          "speakerRoleCertainty",
          "windowCompleteness"
        ],
        "output": "0..1"
      }
    },
    "coach": {
      "outputs": {
        "nextBestSay": {
          "maxItems": 3,
          "style": "shortActionable",
          "mustIncludeEvidence": true
        },
        "nextQuestions": {
          "maxItems": 3,
          "style": "discoveryOrClosing",
          "mustIncludeEvidence": true
        },
        "doDont": {
          "maxItems": 4,
          "style": "behavioral",
          "mustIncludeEvidence": true
        }
      },
      "constraints": {
        "noHallucinatedProductClaims": true,
        "useOnlyMeetingContext": true,
        "avoidSensitiveInferences": true,
        "avoidManipulativeContent": true
      }
    }
  },
  "ui": {
    "section": {
      "name": "Live Analysis",
      "route": "/meeting/:meetingId/live-analysis",
      "entryPoints": ["meetingLiveView", "meetingControlsPanel"]
    },
    "panels": [
      {
        "id": "liveMeters",
        "type": "metricsRow",
        "items": [
          {
            "key": "clientValence",
            "label": "Client Sentiment",
            "visual": "gaugeWithTrend",
            "range": [-1, 1],
            "showConfidence": true
          },
          {
            "key": "clientEngagement",
            "label": "Engagement",
            "visual": "gaugeWithTrend",
            "range": [0, 1],
            "showConfidence": true
          },
          {
            "key": "clientEnergy",
            "label": "Energy (Tone)",
            "visual": "gaugeWithTrend",
            "range": [0, 1],
            "showConfidence": true
          },
          {
            "key": "callHealth",
            "label": "Call Health",
            "visual": "scoreWithTrend",
            "range": [0, 100],
            "showConfidence": true
          },
          { "key": "riskFlags", "label": "Risk Flags", "visual": "chips" }
        ]
      },
      {
        "id": "coachPanel",
        "type": "coach",
        "sections": [
          { "key": "nextBestSay", "label": "Say this next", "maxItems": 3 },
          { "key": "nextQuestions", "label": "Ask next", "maxItems": 3 },
          { "key": "doDont", "label": "Do / Don't", "maxItems": 4 }
        ],
        "actions": [
          { "id": "copySuggestion", "type": "button", "label": "Copy" },
          { "id": "markUsed", "type": "button", "label": "Mark used" },
          { "id": "thumbUpDown", "type": "feedback", "label": "Helpful?" }
        ]
      },
      {
        "id": "insightsTimeline",
        "type": "timeline",
        "items": {
          "fields": [
            "timestamp",
            "type",
            "severity",
            "title",
            "detail",
            "evidenceSnippets",
            "confidence"
          ]
        }
      },
      {
        "id": "talkDynamics",
        "type": "analyticsCard",
        "metrics": [
          {
            "key": "talkRatioSalesPct",
            "label": "Sales Talk %",
            "range": [0, 100]
          },
          {
            "key": "talkRatioClientPct",
            "label": "Client Talk %",
            "range": [0, 100]
          },
          {
            "key": "interruptionsCount",
            "label": "Interruptions",
            "range": [0, 999]
          },
          {
            "key": "paceWpmSales",
            "label": "Sales Pace (WPM)",
            "range": [0, 300]
          },
          {
            "key": "paceWpmClient",
            "label": "Client Pace (WPM)",
            "range": [0, 300]
          }
        ]
      },
      {
        "id": "topicCoverage",
        "type": "checklist",
        "items": [
          { "key": "needProblem", "label": "Need / Problem" },
          { "key": "budget", "label": "Budget" },
          { "key": "timeline", "label": "Timeline" },
          { "key": "decisionMaker", "label": "Decision maker" },
          {
            "key": "alternativesCompetitors",
            "label": "Alternatives / Competitors"
          },
          { "key": "technicalFit", "label": "Technical fit" },
          { "key": "securityCompliance", "label": "Security / Compliance" },
          { "key": "procurement", "label": "Procurement" },
          { "key": "nextSteps", "label": "Next steps" }
        ],
        "behavior": { "autoCheckFromTranscript": true, "manualOverride": true }
      }
    ],
    "controls": {
      "toggles": [
        {
          "id": "toggleLiveAnalysis",
          "label": "Live Analysis",
          "default": false
        },
        {
          "id": "privacyMode",
          "label": "Private mode (local-only if available)",
          "default": false
        }
      ],
      "sliders": [
        {
          "id": "sensitivity",
          "label": "Sensitivity",
          "range": [0, 100],
          "default": 50
        },
        {
          "id": "coachingAggressiveness",
          "label": "Coaching frequency",
          "range": [0, 100],
          "default": 40
        }
      ],
      "status": [
        {
          "key": "streamStatus",
          "values": ["idle", "connecting", "live", "reconnecting", "error"]
        },
        { "key": "latencyMs", "display": "number" }
      ],
      "disclaimer": {
        "required": true,
        "text": "Live Analysis provides AI-generated guidance that may be inaccurate. Use your judgment and follow consent/recording laws."
      }
    }
  },
  "eventProtocol": {
    "envelope": {
      "fields": [
        "eventId",
        "type",
        "meetingId",
        "ts",
        "seq",
        "payload",
        "traceIdOptional"
      ]
    },
    "clientToServer": [
      {
        "type": "control.liveAnalysis.toggle",
        "payloadSchema": {
          "meetingId": "string",
          "enabled": "boolean",
          "privacyMode": "boolean",
          "sensitivity": "number(0..100)",
          "coachingAggressiveness": "number(0..100)"
        }
      },
      {
        "type": "audio.chunk",
        "payloadSchema": {
          "meetingId": "string",
          "audioSource": "microphone|systemAudio|tabAudio",
          "encoding": "pcm_s16le",
          "sampleRateHz": 16000,
          "channels": 1,
          "seq": "number",
          "tsStartMs": "number",
          "tsEndMs": "number",
          "bytesBase64": "string",
          "vadState": "speech|silence"
        }
      },
      {
        "type": "asr.clientPartial",
        "enabledWhen": "localASR=true",
        "payloadSchema": {
          "meetingId": "string",
          "utteranceId": "string",
          "speakerRole": "SALES|CLIENT|UNKNOWN",
          "tsStartMs": "number",
          "tsEndMs": "number",
          "text": "string",
          "confidence": "number(0..1)"
        }
      },
      {
        "type": "prosody.frame",
        "enabledWhen": "prosodyComputeLocation=client",
        "payloadSchema": {
          "meetingId": "string",
          "speakerRole": "CLIENT",
          "windowTsStartMs": "number",
          "windowTsEndMs": "number",
          "features": {
            "rmsEnergy": "number",
            "pitchF0Mean": "number",
            "pitchF0Variance": "number",
            "speechRateProxy": "number",
            "pauseRatio": "number",
            "fillerWordRate": "number"
          },
          "quality": { "snrDb": "number", "voicedMs": "number" }
        }
      },
      {
        "type": "feedback.suggestion",
        "payloadSchema": {
          "meetingId": "string",
          "suggestionId": "string",
          "rating": "up|down",
          "commentOptional": "string"
        }
      }
    ],
    "serverToClient": [
      {
        "type": "stream.status",
        "payloadSchema": {
          "meetingId": "string",
          "status": "idle|connecting|live|reconnecting|error",
          "latencyMs": "number",
          "messageOptional": "string"
        }
      },
      {
        "type": "asr.partial",
        "payloadSchema": {
          "meetingId": "string",
          "utteranceId": "string",
          "speakerId": "string",
          "speakerRole": "SALES|CLIENT|UNKNOWN",
          "tsStartMs": "number",
          "tsEndMs": "number",
          "text": "string",
          "confidence": "number(0..1)"
        }
      },
      {
        "type": "asr.final",
        "payloadSchema": {
          "meetingId": "string",
          "utteranceId": "string",
          "speakerId": "string",
          "speakerRole": "SALES|CLIENT|UNKNOWN",
          "tsStartMs": "number",
          "tsEndMs": "number",
          "text": "string",
          "confidence": "number(0..1)"
        }
      },
      {
        "type": "analysis.metrics",
        "payloadSchema": {
          "meetingId": "string",
          "windowTsStartMs": "number",
          "windowTsEndMs": "number",
          "clientValence": "number(-1..1)",
          "clientValenceConfidence": "number(0..1)",
          "clientEngagement": "number(0..1)",
          "clientEngagementConfidence": "number(0..1)",
          "clientEnergy": "number(0..1)",
          "clientStress": "number(0..1)",
          "clientCertainty": "number(0..1)",
          "callHealth": "number(0..100)",
          "callHealthConfidence": "number(0..1)",
          "riskFlags": "string[]",
          "talkDynamics": {
            "talkRatioSalesPct": "number(0..100)",
            "talkRatioClientPct": "number(0..100)",
            "interruptionsCount": "number",
            "paceWpmSales": "number",
            "paceWpmClient": "number"
          },
          "topicCoverage": {
            "checkedTopics": "string[]",
            "confidenceByTopic": "record<string, number>"
          }
        }
      },
      {
        "type": "analysis.insight",
        "payloadSchema": {
          "meetingId": "string",
          "insightId": "string",
          "timestampMs": "number",
          "type": "objection|risk|positiveSignal|topic|coach",
          "severity": "low|medium|high",
          "title": "string",
          "detail": "string",
          "confidence": "number(0..1)",
          "evidenceSnippets": [
            {
              "utteranceId": "string",
              "speakerRole": "SALES|CLIENT|UNKNOWN",
              "tsStartMs": "number",
              "tsEndMs": "number",
              "text": "string"
            }
          ]
        }
      },
      {
        "type": "analysis.coach",
        "payloadSchema": {
          "meetingId": "string",
          "generatedAtMs": "number",
          "nextBestSay": [
            {
              "suggestionId": "string",
              "text": "string",
              "intent": "addressObjection|clarify|valueReinforce|close|discovery|rapport",
              "confidence": "number(0..1)",
              "evidenceSnippets": "string[]"
            }
          ],
          "nextQuestions": [
            {
              "questionId": "string",
              "text": "string",
              "intent": "discovery|budget|timeline|dm|risk|close",
              "confidence": "number(0..1)",
              "evidenceSnippets": "string[]"
            }
          ],
          "doDont": [
            {
              "id": "string",
              "type": "do|dont",
              "text": "string",
              "confidence": "number(0..1)",
              "evidenceSnippets": "string[]"
            }
          ]
        }
      }
    ]
  },
  "aiRequests": {
    "mode": "hybrid",
    "privacyModeBehavior": {
      "true": {
        "sendAudio": false,
        "sendTranscript": "optional",
        "sendProsody": "optional",
        "allowed": [
          "localMetricsOnly",
          "localCoachOptionalIfOnDeviceModelAvailable"
        ]
      },
      "false": {
        "sendAudio": "configurable",
        "sendTranscript": true,
        "sendProsody": true
      }
    },
    "payloads": {
      "lightMetricsRequest": {
        "trigger": "everyLightMetricsCadence",
        "send": [
          "recentFinalTranscriptsClientOnly",
          "recentProsodyClientOnly",
          "talkDynamicsWindow",
          "activeRiskFlags"
        ],
        "responseExpected": ["analysis.metrics"]
      },
      "deepCoachRequest": {
        "trigger": "everyDeepInsightsCadence",
        "send": [
          "rollingWindowTranscript",
          "meetingMemorySummary",
          "topicCoverageState",
          "recentProsodyClientOnly",
          "currentRiskFlags",
          "productPlaybookOptional"
        ],
        "responseExpected": ["analysis.coach", "analysis.insight"]
      }
    },
    "promptPolicy": {
      "systemGuidance": [
        "Use only the provided transcript/memory; do not invent details.",
        "Provide short actionable coaching suitable for live calls.",
        "Always include evidence snippets for key suggestions.",
        "Avoid manipulative or deceptive tactics.",
        "Avoid sensitive attribute inference."
      ],
      "outputFormat": "strictJson",
      "maxTokensPerMinute": 2500
    }
  },
  "privacyAndCompliance": {
    "consent": {
      "required": true,
      "copy": "Live Analysis uses AI to analyze conversation content and tone to provide coaching. Ensure all participants consent where required."
    },
    "redaction": {
      "enabled": true,
      "patterns": ["email", "phone", "creditCard", "bankAccountOptional"]
    },
    "retention": {
      "audioDays": 0,
      "transcriptDays": 30,
      "insightsDays": 30,
      "configurable": true
    },
    "security": {
      "inTransit": "TLS",
      "atRest": "AES-256",
      "accessControl": "workspaceRBAC",
      "auditLog": true
    }
  },
  "acceptanceCriteria": [
    "Partial transcript appears within ~1.5s average; final transcript emitted after end-of-utterance.",
    "Client sentiment/engagement updates within 5s of relevant client speech.",
    "Tone-based metrics (energy/stress/certainty) appear only when prosody quality gates pass; otherwise UI shows text-only sentiment with reduced confidence.",
    "Coach suggestions include evidence snippets and are rate-limited to avoid flicker/spam.",
    "If connection drops, reconnect resumes without duplicating finalized utterances.",
    "User can stop Live Analysis instantly and all streaming stops; UI reflects status."
  ],
  "phasedRoadmap": [
    {
      "phase": "P0 MVP",
      "scope": [
        "Mic + streaming ASR",
        "Client valence + engagement meters (text-first)",
        "Basic coach suggestions (1-2) with evidence",
        "Insights timeline"
      ]
    },
    {
      "phase": "P1",
      "scope": [
        "Desktop: mic + system audio separation (role assignment by source)",
        "Prosody tone scoring for client energy/stress/certainty",
        "Objection detection categories",
        "Talk dynamics card"
      ]
    },
    {
      "phase": "P2",
      "scope": [
        "Fallback diarization for mixed audio",
        "Multi-speaker support + champion vs skeptic insights",
        "Per-company playbooks and success patterns",
        "Team dashboards and call review analytics"
      ]
    }
  ]
}
