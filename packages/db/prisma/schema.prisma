generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── Enums ───

enum NoteType {
  FREEFORM
  MEETING
}

enum MeetingSessionSource {
  MANUAL
  CALENDAR
}

enum MeetingSessionStatus {
  IDLE
  RECORDING
  PAUSED
  STOPPED
}

enum MeetingPlatform {
  MANUAL
  GOOGLE_MEET
  MS_TEAMS
  ZOOM
  UNKNOWN
}

enum AISummaryKind {
  SUMMARY
  ACTION_ITEMS
  DECISIONS
  RISKS
  KEY_POINTS
}

enum ShareVisibility {
  PRIVATE
  RESTRICTED
}

enum IntegrationProvider {
  NOTION
  SLACK
  TRELLO
  ZAPIER
  GOOGLE_DOCS
}

enum ProcessingJobKind {
  SUMMARIZE
  EXTRACT_ACTIONS
  GENERATE_HTML
  EXPORT_PDF
  EXPORT_DOCX
}

enum ProcessingJobStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum ArtifactType {
  MARKDOWN_SUMMARY
  HTML_SUMMARY
  PDF
  DOCX
}

enum ArtifactStatus {
  NOT_READY
  GENERATING
  READY
  FAILED
}

// ─── Models ───

model User {
  id            String    @id @default(uuid()) @db.Uuid
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  
  // Legacy/App fields
  displayName   String?   @map("display_name")
  avatarUrl     String?   @map("avatar_url")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts      Account[]
  sessions      Session[]
  
  notes           Note[]
  meetingSessions MeetingSession[]
  shareLinks      ShareLink[]
  integrations    UserIntegration[]
  processingJobs  NoteProcessingJob[]
  aiSummaryCount  Int               @default(0) @map("ai_summary_count")

  @@map("users")
}

model Account {
  id                 String  @id @default(uuid()) @db.Uuid
  userId             String  @map("user_id") @db.Uuid
  type               String
  provider           String
  providerAccountId  String  @map("provider_account_id")
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Note {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  title        String
  contentRich  Json      @default("{}") @map("content_rich")
  contentPlain String    @default("") @map("content_plain")
  type         NoteType  @default(FREEFORM)
  tags         String[]  @default([])
  pinned       Boolean   @default(false)
  folderId     String?   @map("folder_id") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  meetingSessions MeetingSession[]
  summaries       AISummary[]
  shareLinks      ShareLink[]
  processingJobs  NoteProcessingJob[]
  artifacts       NoteArtifact[]

  // Template fields
  templateId         String?       @map("template_id") @db.Uuid
  templateMode       TemplateMode  @default(AUTO) @map("template_mode")
  templateSelectedAt DateTime?     @map("template_selected_at")

  template         Template?         @relation(fields: [templateId], references: [id])
  aiGenerationRuns AIGenerationRun[]

  @@index([userId])
  @@index([userId, deletedAt])
  @@index([userId, pinned])
  @@index([userId, updatedAt])
  @@index([userId, folderId])
  @@map("notes")
}

model MeetingSession {
  id               String               @id @default(uuid()) @db.Uuid
  userId           String               @map("user_id") @db.Uuid
  noteId           String               @map("note_id") @db.Uuid
  source           MeetingSessionSource @default(MANUAL)
  platform         MeetingPlatform      @default(MANUAL)
  title            String?
  participants     String[]             @default([])
  startedAt        DateTime             @default(now()) @map("started_at")
  endedAt          DateTime?            @map("ended_at")
  consentConfirmed Boolean              @default(false) @map("consent_confirmed")
  consentText      String?              @map("consent_text")
  audioStored      Boolean              @default(false) @map("audio_stored")
  status           MeetingSessionStatus @default(IDLE)

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  note             Note              @relation(fields: [noteId], references: [id], onDelete: Cascade)
  transcriptChunks TranscriptChunk[]
  summaries        AISummary[]

  @@index([userId])
  @@index([noteId])
  @@map("meeting_sessions")
}

model TranscriptChunk {
  id               String   @id @default(uuid()) @db.Uuid
  meetingSessionId String   @map("meeting_session_id") @db.Uuid
  sequence         Int      @default(0)
  tStartMs         Int      @map("t_start_ms")
  tEndMs           Int      @map("t_end_ms")
  speaker          String?
  text             String
  confidence       Float?
  createdAt        DateTime @default(now()) @map("created_at")

  meetingSession MeetingSession @relation(fields: [meetingSessionId], references: [id], onDelete: Cascade)

  @@index([meetingSessionId])
  @@index([meetingSessionId, sequence])
  @@index([meetingSessionId, tStartMs])
  @@map("transcript_chunks")
}

model AISummary {
  id               String        @id @default(uuid()) @db.Uuid
  noteId           String        @map("note_id") @db.Uuid
  meetingSessionId String?       @map("meeting_session_id") @db.Uuid
  kind             AISummaryKind
  payload          Json
  modelInfo        Json          @default("{}") @map("model_info")
  createdAt        DateTime      @default(now()) @map("created_at")

  note           Note            @relation(fields: [noteId], references: [id], onDelete: Cascade)
  meetingSession MeetingSession? @relation(fields: [meetingSessionId], references: [id], onDelete: SetNull)

  @@index([noteId])
  @@index([noteId, kind])
  @@map("ai_summaries")
}

model ShareLink {
  id              String          @id @default(uuid()) @db.Uuid
  noteId          String          @map("note_id") @db.Uuid
  createdByUserId String          @map("created_by_user_id") @db.Uuid
  visibility      ShareVisibility @default(PRIVATE)
  allowedEmails   String[]        @default([]) @map("allowed_emails")
  token           String          @unique
  expiresAt       DateTime?       @map("expires_at")
  createdAt       DateTime        @default(now()) @map("created_at")

  note      Note @relation(fields: [noteId], references: [id], onDelete: Cascade)
  createdBy User @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([token])
  @@map("share_links")
}

model UserIntegration {
  id           String              @id @default(uuid()) @db.Uuid
  userId       String              @map("user_id") @db.Uuid
  provider     IntegrationProvider
  accessToken  String              @map("access_token") @db.Text
  refreshToken String?             @map("refresh_token") @db.Text
  expiresAt    DateTime?           @map("expires_at")
  metadataJson Json                @default("{}") @map("metadata_json")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([provider])
  @@map("user_integrations")
}

model NoteProcessingJob {
  id          String              @id @default(uuid()) @db.Uuid
  noteId      String              @map("note_id") @db.Uuid
  userId      String              @map("user_id") @db.Uuid
  kind        ProcessingJobKind
  status      ProcessingJobStatus @default(QUEUED)
  progressPct Int                 @default(0) @map("progress_pct")
  message     String?
  startedAt   DateTime?           @map("started_at")
  endedAt     DateTime?           @map("ended_at")
  error       String?
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  note      Note           @relation(fields: [noteId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  artifacts NoteArtifact[]

  @@index([noteId])
  @@index([userId])
  @@index([userId, status])
  @@map("note_processing_jobs")
}

model NoteArtifact {
  id          String         @id @default(uuid()) @db.Uuid
  noteId      String         @map("note_id") @db.Uuid
  jobId       String         @map("job_id") @db.Uuid
  type        ArtifactType
  status      ArtifactStatus @default(NOT_READY)
  storagePath String?        @map("storage_path")
  hash        String?
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  note Note              @relation(fields: [noteId], references: [id], onDelete: Cascade)
  job  NoteProcessingJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([jobId])
  @@index([noteId, type])
  @@map("note_artifacts")
}

// ─── Templates ───

enum TemplateOwnerType {
  SYSTEM
  USER
}

enum TemplateMode {
  AUTO
  SELECTED
}

model Template {
  id            String            @id @default(uuid()) @db.Uuid
  ownerType     TemplateOwnerType
  ownerUserId   String?           @map("owner_user_id") @db.Uuid
  name          String
  icon          String?
  meetingContext String           @map("meeting_context")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  isDeleted     Boolean           @default(false) @map("is_deleted")

  sections      TemplateSection[]
  notes         Note[]
  aiRuns        AIGenerationRun[]

  @@index([ownerType, ownerUserId])
  @@map("templates")
}

model TemplateSection {
  id         String   @id @default(uuid()) @db.Uuid
  templateId String   @map("template_id") @db.Uuid
  order      Int
  title      String
  hint       String?

  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("template_sections")
}

model AIGenerationRun {
  id               String   @id @default(uuid()) @db.Uuid
  noteId           String   @map("note_id") @db.Uuid
  templateId       String?  @map("template_id") @db.Uuid
  templateSnapshot Json     @map("template_snapshot") // Snapshot of template at run time
  status           String   // queued, running, completed, failed
  outputMarkdown   String?  @map("output_markdown")
  outputHtml       String?  @map("output_html")
  createdAt        DateTime @default(now()) @map("created_at")

  note     Note      @relation(fields: [noteId], references: [id], onDelete: Cascade)
  template Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([noteId])
  @@map("ai_generation_runs")
}
